# VHH Designer v7.14 - Change Summary

## Key Changes from v7.12/v7.13

### 1. Within-Track Ranking (`track_rank` field)

Added a new field `track_rank` to enable sorting within the control bucket without mixing objectives. This is a local rank (1-indexed) within each track+hallmark combination.

**Output columns now include:**
- `track_rank`: Position within track (e.g., "best ESM within minimal YQRL")
- `is_immutable`: Flag indicating no post-generation modifications allowed

### 2. Explicit Immutability for Track 0

Minimal hallmark controls are now explicitly flagged as immutable:
- `is_immutable = True` for all Track 0 candidates
- Clear comments: "If this breaks, the hallmark itself is incompatible"
- No compensation rules applied
- No consensus sprinkling

### 3. Distance-First Sorting for Tracks 0-3

Different tracks now have different sorting objectives:

| Track | Sort Order | Rationale |
|-------|-----------|-----------|
| **Track 0** | `n_mutations` ASC, then `esm_loss` ASC | 4mut beats 5mut unless ESM dramatically worse |
| **Track 1** | `esm_loss` ASC | Distance is constant (~5-6 mutations) |
| **Track 2** | `esm_loss` ASC, tie-break by `n_mutations` ASC | Prefer fewer mutations at same ESM |
| **Track 3** | `esm_loss` ASC | ESM is primary signal |
| **Track 4** | `combined_score` DESC | Full optimization |

### 4. Capped Probe Complexity

Reduced probe counts to focus on information quality over volume:

| Track | Old Max | New Max | Rationale |
|-------|---------|---------|-----------|
| Track 1 (single) | 10 | **6** | Focus on top-confidence verniers |
| Track 2 (paired) | 8 | **6** | Only high-confidence pairs |
| Track 3 (triplet) | 4 | **3** | Testing causality, not coverage |

---

## Bug Fixes

### 5. Weight Normalization Fix

**Problem:** Weight normalization used raw `use_esm2` flag instead of `self.use_esm2`, causing incorrect weights when user requested ESM2 but it was unavailable at runtime.

**Fix:** Now uses `self.use_esm2`/`self.use_esmfold` which reflect actual runtime availability.

### 6. Removed Duplicate CLI Argument

**Problem:** Both `--rule-weight` and `--rules-weight` existed, differing only by an "s", causing silent misconfiguration.

**Fix:** Removed `--rules-weight`, only `--rule-weight` remains.

### 7. Deterministic Sorting Fallback When ESM2 Unavailable

**Problem:** Track sorting used `esm2_loss`, but when ESM2 is off, all values become 0 and ordering becomes arbitrary.

**Fix:** When `esm_available = False`, sorting falls back to deterministic ordering:
- `n_mutations` → `framework_identity` → `generation_order`

### 8. Immutability Seatbelt Validation

Added `validate_immutable_candidate()` function that checks Track 0 candidates after scoring to ensure:
- Mutations only at allowed positions (hallmarks + IMGT2)
- No compensation rules applied
- No triplet rules applied

This prevents regressions where downstream code accidentally modifies immutable candidates.

---

## Expected Output Structure

For a run with 6 hallmarks and 20K generation:
- **~12 Track 0 controls** (2 per hallmark: 4mut + 5mut)
- **~36 Track 1 probes** (6 singles × 6 hallmarks)
- **~36 Track 2 probes** (6 pairs × 6 hallmarks)
- **~18 Track 3 probes** (3 triplets × 6 hallmarks, if available)
- **~99 Track 4 ranked** (per --n-select)

Total: ~150-200 sequences including controls

---

## New Output Columns

```
rank              # Global rank (-N for exempt, +N for ranked)
track_rank        # Within-track rank (1, 2, 3... within track+hallmark)
design_track      # lead, minimal_hallmark, single_vernier, paired_vernier, triplet_vernier, optimized
ranking_exempt    # True for Track 0-3
track_info        # Details (e.g., "YQRL_4mut", "IMGT69_E>D")
is_immutable      # True for Track 0
```

---

## Usage

```bash
python vhh_designer_v7_14.py -i M69.fasta \
  --rules analysis_rules_v7.json \
  --archetypes analysis_vernier_archetypes_v7.json \
  --hallmark-db comprehensive_subfamily_analysis_imgt.xlsx \
  --target-hallmarks AUTO \
  --target-families F_C2 F_C4 Y_C2 Y_C4 \
  --mode original \
  --n-generate 20000 \
  --n-select 99 \
  --no-esmfold
```

---

## Smoke Test Checklist

1. **Generation test:** `--n-generate 50 --n-select 10 --no-esmfold`
2. **Track counts:** ~2 Track0/hallmark, ≤6 Track1, ≤6 Track2, ≤3 Track3
3. **Immutability:** Track 0 candidates have only hallmark mutations, empty `applied_comp_rules`
4. **Ranking:** Exempt candidates have negative ranks, ranked have positive ranks
5. **track_rank:** Increments within (design_track, hallmark) as expected
